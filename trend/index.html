<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <style>
    .dashboard {
      font-family: "Helvetica Neue", Arial;
      font-size: 1.1em;
      margin-left: 10px;
      margin-right: 10px;
      margin-top: 25px;
    }

    select {
      font-size: 1.1em;
    }
    .modal-dialog-backdrop {
      position: fixed;
      /* Stay in place */
      z-index: 1;
      /* Sit on top */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.4);
      /* Black w/ opacity */
    }

    .modal-dialog-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      padding-top: 10px;
      border: 1px solid #888;
    }
    .modal-dialog-toolbar {
      text-align: right;
      font-size: 1.5em;
    }

  </style>
</head>

<body>

  <div class="dashboard">
    <div class="toolbar">
      <div>
        State:
        <select v-model="selectedState" @change="processData">
          <option v-for="s in stateList" :value="s">{{s}}</option>
        </select>
        <img src="settings.svg" width="25px" @click="$refs.settingsDialog.open()"/>
        <br />
        <label v-for="prop in propertyList">
          <input type="radio" v-model="selectedProperty" :value="prop" @change="processData" /> {{prop.label}}
        </label>
      </div>
    </div>
    <modal-dialog ref="settingsDialog">
      <div>
        Source:
        <select v-model="selectedDataSource" @change="updateDisplay">
          <option v-for="d in dataSourceList" :value="d">{{d.label}}</option>
        </select>
      </div>
      <div>
        Show 
        <select v-model="movingAverageDays" @change="processData">
          <option :value="7">7 days</option>
          <option :value="10">10 days</option>
          <option :value="14">14 days</option>
        </select>
        moving average.
      </div>
    </modal-dialog>
    <canvas id="chart"></canvas>
  </div>

  <script>
    Vue.component("modal-dialog", {
      template: `
      <div class="modal-dialog-backdrop" :style="{display: isShown ? 'block' : 'none'}">
        <div class="modal-dialog-content" :style="{maxWidth: maxWidth}">
          <div class="modal-dialog-toolbar" @click="close">&times;</div>
          <slot></slot>
        </div>
      </div>
      `,
      props: {
        maxWidth: {
          default: "250px"
        }
      },
      data() {
        return {
          isShown: false
        }
      },
      methods: {
        open() {
          this.isShown = true
        },
        close() {
          this.isShown = false
        }
      }
    })

    var helloApp = new Vue({
      el: '.dashboard',
      data: {
        selectedState: "",
        stateList: [],
        historyData: [],
        movingAverageDays: 7,
        selectedProperty: undefined,
        chart: undefined,
        propertyList: [
          {
            name: "positiveIncrease",
            label: "New Positive Cases",
            color: "#3e95cd"
          },
          {
            name: "deathIncrease",
            label: "New Deaths",
            color: "#8e5ea2"
          }
        ],
        dataSourceList: [
          {
            label: "New York Times",
            fetchData() {
              return fetch("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
                .then(response => response.text())
                .then(text => {
                  let lines = text.split("\n")

                  lines.shift() //Get rid of header

                  let lastPositiveMap = new Map()
                  let lastDeathMap = new Map()

                  let data = lines.map(line => {
                    let [dayStr, state, fips, cases, deaths] = line.split(",")

                    let lastPositive = lastPositiveMap.get(state) ? lastPositiveMap.get(state) : 0
                    let lastDeath = lastDeathMap.get(state) ? lastDeathMap.get(state) : 0

                    let date = Date.parse(dayStr)
                    let positiveIncrease = cases - lastPositive
                    let deathIncrease = deaths - lastDeath

                    // if (state === "Florida") {
                    //   console.log(dayStr, cases, deaths, positiveIncrease, deathIncrease)
                    // }

                    lastPositiveMap.set(state, cases)
                    lastDeathMap.set(state, deaths)

                    return {
                      date,
                      state,
                      positiveIncrease,
                      deathIncrease
                    }
                  })

                  return data
                })
            }
          },
          {
            label: "CovidTracking.com",
            fetchData() {
              return fetch("https://covidtracking.com/api/states/daily")
                .then(response => response.json())
            }
          }
        ],
        selectedDataSource: undefined
      },
      methods: {
        updateDisplay() {
          console.log("Updating display")
          return this.selectedDataSource.fetchData()
            .then(data => {
              this.historyData = data
              this.buildStateNameList()
              this.selectedState = this.stateList[0]

              this.processData()
            })
        },
        buildStateNameList() {
          let stateDict = new Map()

          this.stateList.length = 0 //Clear

          this.historyData.forEach(rec => stateDict.set(rec.state, rec.state))
          stateDict.forEach(value => { this.stateList.push(value) })
          this.stateList.sort()
        },
        processData() {
          let stateData = this.historyData
            .filter(record => record.state === this.selectedState)
            .sort((r1, r2) => {
              if (r1.date < r2.date) return -1
              else if (r1.date > r2.date) return 1
              else return 0
            })

          let labelList = []
          let maList = []

          this.computeMovingAvg(stateData, labelList, maList, this.selectedProperty.name)

          // maList.forEach(avg => console.log(avg))
          this.renderGraph(labelList, maList, this.selectedProperty)
        },
        computeMovingAvg(stateData, labelList, maList, propertyName) {
          for (i = 0; i < stateData.length - this.movingAverageDays; ++i) {
            let sum = 0

            for (j = i; j < i + this.movingAverageDays; ++j) {
              let incr = stateData[j][propertyName] !== null ? stateData[j][propertyName] : 0

              sum += incr
            }
            labelList.push(i)
            maList.push(sum / this.movingAverageDays)
          }
        },
        renderGraph(labelList, maList, prop) {
          this.chart.data.labels = labelList
          this.chart.data.datasets[0] = {
            data: maList,
            label: prop.label,
            borderColor: prop.color,
            fill: false
          }
          this.chart.update()
        }
      },
      mounted() {
        let ctx = document.getElementById('chart').getContext('2d')

        this.chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: []
          },
          options: {}
        })

        this.selectedProperty = this.propertyList[0]
        this.selectedDataSource = this.dataSourceList[0]

        this.updateDisplay()
          .catch(err => { console.log(err); alert("Sorry there was an error. Please try again.") })
      },
      computed: {
      }
    })
  </script>
</body>

</html>